{% extends 'myapp/base.html' %}

{% block title %} Operation Monitor | Factory OS {% endblock title %}

{% block content %}
<!-- Use Google Fonts for Modern Typography -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .dark .glass-panel {
        background: rgba(30, 41, 59, 0.7);
    }
</style>

<div
    class="flex h-screen overflow-hidden bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- Modern Sidebar -->
    <aside
        class="w-20 lg:w-64 flex-shrink-0 bg-white/80 dark:bg-[#1e293b]/90 border-r border-slate-200 dark:border-slate-800 backdrop-blur-md flex flex-col transition-all duration-300 z-20 hidden md:flex">
        <!-- Logo Area -->
        <div
            class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-200/50 dark:border-slate-700/50">
            <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-500/20 text-white">
                <i data-lucide="cpu" class="w-6 h-6"></i>
            </div>
            <span
                class="ml-3 font-bold text-lg tracking-tight hidden lg:block text-slate-800 dark:text-slate-100">Factory
                OS</span>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto">
            <a href="{% url 'boiler' %}"
                class="flex items-center gap-3 px-3 py-2.5 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all group">
                <i data-lucide="arrow-left" class="w-5 h-5 group-hover:-translate-x-1 transition-transform"></i>
                <span class="hidden lg:block font-medium">Back to Overview</span>
            </a>

            <div class="my-4 border-t border-slate-200 dark:border-slate-700 mx-2"></div>

            <div class="px-2 mb-2 hidden lg:block text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Monitoring</div>

            <a href="#"
                class="flex items-center gap-3 px-3 py-2.5 bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 rounded-xl transition-all font-medium border border-indigo-100 dark:border-indigo-500/20">
                <i data-lucide="activity" class="w-5 h-5"></i>
                <span class="hidden lg:block">Operation Monitor</span>
            </a>

            <div class="px-2 mt-6 mb-2 hidden lg:block text-xs font-semibold text-slate-400 uppercase tracking-wider">
                Actions</div>

            <button onclick="openUploadModal()"
                class="w-full flex items-center gap-3 px-3 py-2.5 text-emerald-600 hover:bg-emerald-50 dark:text-emerald-400 dark:hover:bg-emerald-500/10 rounded-xl transition-all font-medium hover:shadow-sm">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                <span class="hidden lg:block">Import Log File</span>
            </button>
        </nav>

        <!-- User Profile (Bottom) -->
        <div class="p-4 border-t border-slate-200/50 dark:border-slate-700/50">
            <a href="{% url 'logout' %}" onclick="return confirm('Confirm Logout?')"
                class="flex items-center justify-center lg:justify-start gap-3 w-full p-2 text-slate-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span class="hidden lg:block font-medium">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50 dark:bg-[#0f172a]">
        <!-- Topbar -->
        <header
            class="h-16 glass-panel border-b border-slate-200/50 dark:border-slate-800/50 flex items-center justify-between px-6 z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <button class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg"><i
                        data-lucide="menu"></i></button>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 dark:text-white">Machine Operation</h1>
                    <p class="text-xs text-slate-500 hidden sm:block">Detailed Real-time Monitoring</p>
                </div>
                <span
                    class="hidden sm:flex px-2 py-0.5 rounded-md bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 text-xs font-medium border border-green-200 dark:border-green-800 items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Live
                </span>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden md:block">
                    <div class="text-xs text-slate-500 dark:text-slate-400">Current Time</div>
                    <div class="text-sm font-mono font-medium text-slate-700 dark:text-slate-200" id="live-clock">
                        --:--:--</div>
                </div>
                <div
                    class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold border border-indigo-200">
                    A
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">

            <!-- Machine Selector (Tabs) -->
            <div class="mb-8">
                <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar" id="machine-tabs">
                    <!-- Tabs will be generated via JS -->
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="max-w-7xl mx-auto pb-20">
                <!-- Header Info for Selected Machine -->
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight" id="machine-title">
                            Loading...</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2 text-sm">
                            <i data-lucide="database" class="w-4 h-4"></i> Last Data: <span id="last-update-time"
                                class="font-mono text-slate-700 dark:text-slate-300 font-medium">--</span>
                        </p>
                    </div>

                    <!-- Quick Action Button (Add Log) -->
                    <a href="#" id="btn-add-log"
                        class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-600/30 transition-all active:scale-95 font-medium">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span>Manual Entry</span>
                    </a>
                </div>

                <!-- Critical Metrics (Hero Cards) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

                    <!-- Pressure Card -->
                    <div onclick="openDrillDown('press')"
                        class="cursor-pointer bg-white dark:bg-[#1e293b] rounded-3xl p-6 border border-slate-100 dark:border-slate-700 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden group hover:border-cyan-200 transition-colors flex flex-col items-center justify-between min-h-[250px]">

                        <div class="absolute top-4 left-6 z-10">
                            <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Steam Pressure</h3>
                        </div>

                        <div class="relative h-44 w-full mt-4 flex justify-center" id="svg-container-press">
                            <!-- SVG Injected Here -->
                        </div>

                        <div class="mt-[-10px] text-center z-10">
                            <div class="text-xs text-slate-400 mt-1">Target: <span id="target-press">--</span> Bar</div>
                        </div>
                    </div>

                    <!-- Flow Card -->
                    <div onclick="openDrillDown('flow')"
                        class="cursor-pointer bg-white dark:bg-[#1e293b] rounded-3xl p-6 border border-slate-100 dark:border-slate-700 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden group hover:border-blue-200 transition-colors flex flex-col items-center justify-between min-h-[250px]">

                        <div class="absolute top-4 left-6 z-10">
                            <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Steam Flow</h3>
                        </div>

                        <div class="relative h-44 w-full mt-4 flex justify-center" id="svg-container-flow">
                            <!-- SVG Injected Here -->
                        </div>

                        <div class="mt-[-10px] text-center z-10">
                            <div class="text-xs text-slate-400 mt-1">Target: <span id="target-flow">--</span> T/H</div>
                        </div>
                    </div>

                    <!-- Temp Card -->
                    <div onclick="openDrillDown('temp')"
                        class="cursor-pointer bg-white dark:bg-[#1e293b] rounded-3xl p-6 border border-slate-100 dark:border-slate-700 shadow-xl shadow-slate-200/50 dark:shadow-none relative overflow-hidden group hover:border-orange-200 transition-colors flex flex-col items-center justify-between min-h-[250px]">

                        <div class="absolute top-4 left-6 z-10">
                            <h3 class="text-lg font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Steam Temp</h3>
                        </div>

                        <div class="relative h-44 w-full mt-4 flex justify-center" id="svg-container-temp">
                            <!-- SVG Injected Here -->
                        </div>

                        <div class="mt-[-10px] text-center z-10">
                            <div class="text-xs text-slate-400 mt-1">Target: <span id="target-temp">--</span> °C</div>
                        </div>
                    </div>
                </div>

                <!-- All Parameters Grid (Dynamic) -->
                <div class="flex items-center gap-2 mb-4 px-1 mt-8">
                    <div class="w-1 h-6 bg-indigo-500 rounded-full"></div>
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200">All Parameters</h3>
                </div>

                <div id="dynamic-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Javascript will populate this -->
                </div>

            </div>
        </div>
    </main>

    <!-- Upload Modal (Modern Style) -->
    <div id="uploadModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeUploadModal()">
        </div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-[#1e293b] text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-200 dark:border-slate-700">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-5">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <div class="bg-indigo-100 dark:bg-indigo-900/30 p-2 rounded-full text-indigo-600">
                                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                </div>
                                Import Data
                            </h3>
                            <button onclick="closeUploadModal()"
                                class="text-slate-400 hover:text-slate-500 p-1 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <form action="{% url 'import_data' %}" method="POST" enctype="multipart/form-data"
                            class="space-y-5">
                            {% csrf_token %}
                            <div>
                                <label
                                    class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Select
                                    Machine / Log Sheet</label>
                                <select id="machine_type" name="machine_type"
                                    class="w-full rounded-xl border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2.5 px-3">
                                    <option value="john_thomson">John Thomson</option>
                                    <option value="chengchen">Chengchen</option>
                                    <option value="takuma">Takuma</option>
                                    <option value="yoshimine">Yoshimine</option>
                                    <option value="banpong1">Banpong 1</option>
                                    <option value="banpong2">Banpong 2</option>
                                </select>
                            </div>

                            <div
                                class="group relative flex justify-center rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 py-10 transition-all hover:border-indigo-500 hover:bg-indigo-50/50 dark:hover:bg-slate-800/80 cursor-pointer">
                                <div class="text-center">
                                    <i data-lucide="file-spreadsheet"
                                        class="mx-auto h-12 w-12 text-slate-300 group-hover:text-indigo-500 transition-colors duration-300"></i>
                                    <div class="mt-4 flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                        <label for="file-upload"
                                            class="relative cursor-pointer rounded-md bg-transparent font-medium text-indigo-600 focus-within:outline-none hover:text-indigo-500">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file_upload" type="file" class="sr-only"
                                                accept=".csv, .xlsx, .xls" onchange="showFileName(this)">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-slate-500 dark:text-slate-500 mt-1">Excel or CSV up to 10MB
                                    </p>
                                    <p id="file-name-display" class="text-sm font-medium text-indigo-600 mt-3 h-5"></p>
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-2">
                                <button type="button" onclick="closeUploadModal()"
                                    class="px-5 py-2.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-xl hover:bg-slate-50 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                                <button type="submit"
                                    class="px-5 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-600/30 transition-all active:scale-95">Upload
                                    & Import</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drill Down Modal -->
    <div id="drillDownModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDrillDown()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-4xl transform rounded-2xl bg-white dark:bg-[#1e293b] p-6 text-left shadow-2xl transition-all border border-slate-200 dark:border-slate-700">

                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="dd-title">History Analysis
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">7 Days Historical Data</p>
                        </div>
                        <button onclick="closeDrillDown()"
                            class="p-2 text-slate-400 hover:text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Controls -->
                    <div class="flex flex-wrap gap-4 mb-6 items-end bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">Start Date</label>
                            <input type="date" id="dd-start"
                                class="rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">End Date</label>
                            <input type="date" id="dd-end"
                                class="rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-indigo-500">
                        </div>
                        <button onclick="fetchHistoryData()"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-600/20">
                            Apply Filter
                        </button>
                    </div>

                    <!-- Chart -->
                    <div class="relative h-80 w-full">
                        <canvas id="historyChart"></canvas>
                    </div>

                </div>
            </div>
        </div>
    </div>


</div>

<!-- JavaScript Logic -->
<script>
    // --- Clock Logic ---
    function updateClock() {
        const now = new Date();
        document.getElementById('live-clock').innerText = now.toLocaleTimeString('en-GB');
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- Modal Logic ---
    function openUploadModal() {
        document.getElementById('uploadModal').classList.remove('hidden');
    }
    function closeUploadModal() {
        document.getElementById('uploadModal').classList.add('hidden');
    }
    function showFileName(input) {
        const display = document.getElementById('file-name-display');
        if (input.files && input.files[0]) {
            display.textContent = input.files[0].name;
        }
    }

    // --- Config & Data ---
    // รับข้อมูล JSON จาก Django View (ถ้าไม่มีให้ใช้ Mock เพื่อป้องกันหน้าขาว)
    let machineData = {};
    try {
        const rawJson = '{{ machine_data_json|safe }}';
        machineData = JSON.parse(rawJson);
    } catch (e) {
        console.warn("Using Mock Data");
        machineData = {
            john_thomson: { name: 'John Thomson', press: 21.5, flow: 46, temp: 255, fw_flow: 41, dea_temp: 106, stack_temp: 182, ph: 8.6, bd_flow: 5.1 },
            chengchen: { name: 'Chengchen', press: 41.2, flow: 82, temp: 405, fw_flow: 81, dea_temp: 106, stack_temp: 181, ph: 9.1, bd_flow: 5.2 },
            takuma: { name: 'Takuma', press: 39.8, flow: 78, temp: 395, fw_flow: 79, dea_temp: 104, stack_temp: 179, ph: 8.9, bd_flow: 4.8 },
            yoshimine: { name: 'Yoshimine', press: 19.5, flow: 44, temp: 248, fw_flow: 39, dea_temp: 104, stack_temp: 178, ph: 8.4, bd_flow: 4.9 },
            banpong1: { name: 'Banpong 1', press: 20.1, flow: 45.5, temp: 251, fw_flow: 40.5, dea_temp: 105.5, stack_temp: 180.5, ph: 8.55, bd_flow: 5.05 },
            banpong2: { name: 'Banpong 2', press: 20.0, flow: 45.0, temp: 250, fw_flow: 40.0, dea_temp: 105.0, stack_temp: 180.0, ph: 8.5, bd_flow: 5.0 }
        };
    }

    const machineList = [
        { id: 'john_thomson', label: 'John Thomson', url: "{% url 'boiler_operation_add' %}" },
        { id: 'chengchen', label: 'Chengchen', url: "{% url 'chengchen_operation_add' %}" },
        { id: 'takuma', label: 'Takuma', url: "{% url 'takuma_operation_add' %}" },
        { id: 'yoshimine', label: 'Yoshimine', url: "{% url 'yoshimine_operation_add' %}" },
        { id: 'banpong1', label: 'Banpong 1', url: "{% url 'banpong1_operation_add' %}" },
        { id: 'banpong2', label: 'Banpong 2', url: "{% url 'banpong2_operation_add' %}" }
    ];

    const targets = {
        john_thomson: { press: 22, flow: 200, temp: 360, fw_flow: 200, dea_temp: 105, stack_temp: 160, ph: 9.5, bd_flow: 5 },
        chengchen: { press: 22, flow: 60, temp: 360, fw_flow: 60, dea_temp: 105, stack_temp: 160, ph: 9.5, bd_flow: 5 },
        takuma: { press: 22, flow: 60, temp: 360, fw_flow: 60, dea_temp: 105, stack_temp: 160, ph: 9.5, bd_flow: 5 },
        yoshimine: { press: 42, flow: 150, temp: 460, fw_flow: 150, dea_temp: 105, stack_temp: 160, ph: 9.0, bd_flow: 3 },
        banpong1: { press: 42, flow: 150, temp: 460, fw_flow: 150, dea_temp: 105, stack_temp: 160, ph: 9.0, bd_flow: 3 },
        banpong2: { press: 42, flow: 150, temp: 460, fw_flow: 150, dea_temp: 105, stack_temp: 160, ph: 9.0, bd_flow: 3 },
    };

    let currentMachine = 'john_thomson';

    function initTabs() {
        const container = document.getElementById('machine-tabs');
        container.innerHTML = machineList.map(m => `
            <button onclick="switchMachine('${m.id}')" id="tab-${m.id}" 
                class="whitespace-nowrap px-6 py-3 rounded-2xl text-sm font-medium transition-all duration-300 border border-transparent shadow-sm">
                ${m.label}
            </button>
        `).join('');
        switchMachine(currentMachine);
    }

    // --- SVG Gauge Logic (Ported from Mill) ---
    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 180) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function describeArcStroke(x, y, radius, startAngle, endAngle) {
        var start = polarToCartesian(x, y, radius, endAngle);
        var end = polarToCartesian(x, y, radius, startAngle);
        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        return [
            "M", start.x, start.y,
            "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
        ].join(" ");
    }

    function renderSVGGauge(type, val, target) {
        const container = document.getElementById(`svg-container-${type}`);
        const elTgt = document.getElementById(`target-${type}`);

        if (!val || val === '-') {
            container.innerHTML = '<span class="text-slate-400 self-center">No Data</span>';
            elTgt.innerText = target || '-';
            return;
        }

        const v = parseFloat(val);
        const t = parseFloat(target || 1);
        elTgt.innerText = t;

        // Logic for Boiler: Center (Target) is best
        // Range: 0 to Target * 2 ? Or Target +/- 50%?
        // Let's use 0 to Target*2 for symmetry, putting Target at 90 deg (Top Center)

        const minVal = 0;
        const maxVal = t * 2;

        // Clamp percentage
        let percent = ((v - minVal) / (maxVal - minVal)) * 100;
        percent = Math.min(100, Math.max(0, percent));

        const needleAngle = (percent / 100) * 180;

        // Colors for segments
        // 0-60 (Low) = Yellow/Red
        // 60-120 (Target Zone) = Green
        // 120-180 (High) = Yellow/Red

        const col1 = "#eab308"; // Yellow
        const col2 = "#22c55e"; // Green
        const col3 = "#ef4444"; // Red

        const unit = type === 'press' ? 'Bar' : (type === 'flow' ? 'T/H' : '°C');

        const svg = `
            <div class="w-full h-full flex flex-col justify-end items-center">
                <svg class="w-48 h-28 overflow-visible" viewBox="0 0 200 110" preserveAspectRatio="xMidYMax">
                    <!-- Segments -->
                    <path d="${describeArcStroke(100, 100, 80, 0, 60)}" fill="none" stroke="${col1}" stroke-width="20" opacity="0.8" />
                    <path d="${describeArcStroke(100, 100, 80, 60, 120)}" fill="none" stroke="${col2}" stroke-width="20" opacity="0.8" />
                    <path d="${describeArcStroke(100, 100, 80, 120, 180)}" fill="none" stroke="${col3}" stroke-width="20" opacity="0.8" />
                    
                    <!-- Labels -->
                    <text x="25" y="105" text-anchor="middle" class="text-[10px] font-bold fill-slate-400">0</text>
                    <text x="100" y="15" text-anchor="middle" class="text-[10px] font-bold fill-slate-400">${t}</text>
                    <text x="175" y="105" text-anchor="middle" class="text-[10px] font-bold fill-slate-400">${maxVal}</text>

                    <!-- Needle -->
                    <line x1="100" y1="100" 
                          x2="${100 + 70 * Math.cos((needleAngle - 180) * Math.PI / 180)}" 
                          y2="${100 + 70 * Math.sin((needleAngle - 180) * Math.PI / 180)}" 
                          stroke="#334155" stroke-width="4" stroke-linecap="round" 
                          class="dark:stroke-white transition-all duration-1000 ease-out origin-bottom" />
                    <circle cx="100" cy="100" r="5" fill="#334155" class="dark:fill-white" />
                </svg>
                
                <!-- Value Text (Moved below SVG with margin) -->
                <div class="text-center mt-2 z-10">
                    <div class="text-3xl font-bold text-slate-800 dark:text-white leading-none">${v}</div>
                    <div class="text-xs text-slate-400 font-medium">${unit}</div>
                </div>
            </div>
        `;

        container.innerHTML = svg;
    }

    // Refactored switchMachine to use new updateGauge
    function switchMachine(key) {
        currentMachine = key;
        const data = machineData[key] || {};
        const tgt = targets[key] || {};
        const machineInfo = machineList.find(m => m.id === key);

        // Update Tabs UI (Active/Inactive State)
        machineList.forEach(m => {
            const btn = document.getElementById(`tab-${m.id}`);
            if (m.id === key) {
                btn.className = "whitespace-nowrap px-6 py-3 rounded-2xl text-sm font-bold bg-indigo-600 text-white shadow-lg shadow-indigo-600/30 transform scale-105 transition-all duration-300";
            } else {
                btn.className = "whitespace-nowrap px-6 py-3 rounded-2xl text-sm font-medium text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all duration-300";
            }
        });

        // Update Content
        document.getElementById('machine-title').innerText = data.name || machineInfo.label;
        document.getElementById('last-update-time').innerText = (new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }));
        document.getElementById('btn-add-log').href = machineInfo.url;

        // Update Gauges (SVG)
        renderSVGGauge('press', data.press, tgt.press);
        renderSVGGauge('flow', data.flow, tgt.flow);
        renderSVGGauge('temp', data.temp, tgt.temp);

        // Update All Fields Grid
        const container = document.getElementById('dynamic-cards');
        container.innerHTML = '';

        if (data.all_fields && data.all_fields.length > 0) {
            data.all_fields.forEach(field => {
                // Shorten some verbose names for UI
                let label = field.label || field.name;
                label = label.replace("Continous Emissions Monitoring", "CEM");

                // Determine Icon based on name logic
                let icon = 'activity';
                if (label.toLowerCase().includes('pressure')) icon = 'gauge';
                if (label.toLowerCase().includes('flow')) icon = 'wind';
                if (label.toLowerCase().includes('temp')) icon = 'thermometer';
                if (label.toLowerCase().includes('level')) icon = 'bar-chart-2';
                if (label.toLowerCase().includes('valve')) icon = 'settings-2';
                if (label.toLowerCase().includes('damper')) icon = 'fan';
                if (label.toLowerCase().includes('amp')) icon = 'zap';

                const card = `
                    <div onclick="openDrillDown('${field.name}')" 
                        class="cursor-pointer bg-white dark:bg-[#1e293b] p-4 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-indigo-400 hover:shadow-md transition-all group">
                        <div class="flex items-start justify-between mb-3 min-h-[40px]">
                            <span class="text-xs font-semibold text-slate-500 uppercase line-clamp-2">${label}</span>
                            <i data-lucide="${icon}" class="w-4 h-4 text-indigo-500 group-hover:scale-110 transition-transform flex-shrink-0 ml-2"></i>
                        </div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-lg font-bold text-slate-800 dark:text-white truncate" title="${field.value}">${field.value}</span>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });

            // Re-init icons for new content
            if (window.lucide) window.lucide.createIcons();

        } else {
            container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">No detailed parameters available</div>`;
        }

    }

    // Deprecated updateCard
    function updateCard(type, val, target) {
        // ... replaced by updateGauge
    }

    function updateMiniCard(type, val, target) {
        // Deprecated by dynamic grid, keeping blank for safety if called elsewhere
    }

    // --- Drill Down Logic ---
    let currentMetric = 'press';
    let chartInstance = null;

    function openDrillDown(metric) {
        currentMetric = metric;
        const modal = document.getElementById('drillDownModal');
        const title = document.getElementById('dd-title');

        let label = metric;
        // Generic cleanup
        label = label.replace(/_/g, ' ').replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());

        title.innerText = `${machineData[currentMachine].name} - ${label}`;

        // Default Dates (Last 7 Days)
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 7);

        document.getElementById('dd-end').valueAsDate = end;
        document.getElementById('dd-start').valueAsDate = start;

        modal.classList.remove('hidden');
        fetchHistoryData();
    }

    function closeDrillDown() {
        document.getElementById('drillDownModal').classList.add('hidden');
    }

    async function fetchHistoryData() {
        const start = document.getElementById('dd-start').value;
        const end = document.getElementById('dd-end').value;
        const url = `{% url 'boiler_history_api' %}?machine=${currentMachine}&metric=${currentMetric}&start_date=${start}&end_date=${end}`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            renderChart(data.labels, data.data, data.metric_label || currentMetric);
        } catch (e) {
            console.error(e);
            alert("Failed to load data");
        }
    }

    function renderChart(labels, data, label) {
        const ctx = document.getElementById('historyChart').getContext('2d');

        if (chartInstance) {
            chartInstance.destroy();
        }

        // Color Logic
        let color = '#6366f1'; // Indigo
        if (currentMetric === 'press') color = '#06b6d4'; // Cyan
        if (currentMetric === 'flow') color = '#3b82f6'; // Blue
        if (currentMetric === 'temp') color = '#f97316'; // Orange

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20', // Opacity
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { border: { dash: [4, 4] } }
                }
            }
        });
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) window.lucide.createIcons();
        initTabs();
    });

</script>
{% endblock content %}